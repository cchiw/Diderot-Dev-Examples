
  \subsection{Composition}
\begin{lstlisting}
field#k(d0)[$\sigma$] F0;
field#k(d1)[d0] F1;
field#k(d1)[$\sigma$] H = F0 $\circ$ F1; 
tensor[d1] pos;
tensor[$\sigma$] out = H(pos);
\end{lstlisting}

\paragraph{Representation}
We represent the field composition operator with the generic \name{} operator.
$$\rewriteInitA  H= \lambda(F,G) \EinExp{\expComp{F_\alpha}{G_\beta}{\beta}}{\hat{\alpha}}(F0,F1) \indent\text{ where } \hat{\alpha}=\sigma \text{ and } \hat{\beta} =[d0]$$
The field terms F and G represent fields in the composition.
F and G have separate index spaces. $F$ is bound by $\alpha$ and $G$ is bound by $\beta$.\\
 

\paragraph{Normalization}
%\paragraph{probe}
The probe of a composition
 $(\expComp{e_1}{e_2}{\beta})(x)$ 
 is rewritten depending on the structure of the outer term $e_1$. 
When the outer term is a constant the result does not depend on the composition operation.
$$(\expCompSingle{ c}{e_2}{\beta})(x) \rewriteRule{} c $$
Similarily, when the outer term is a non-field:
$$\begin{array}{lllllll}
(\expCompSingle{ \delta_{\alpha}}{e_2}{\beta})(x) &\rewriteRule{} \delta_{\alpha}& \indent &
(\expCompSingle{ \mathcal{E}_{\alpha}}{e_2}{\beta})(x) &\rewriteRule{} \mathcal{E}_{\alpha}\\
(\expCompSingle{ Z_{\alpha}}{e_2}{\beta})(x) &\rewriteRule{} Z_{\alpha} &&
(\expCompSingle{ \lift{e}}{e_2}{\beta})(x) &\rewriteRule{} e &
\end{array}$$
The probe operator is pushed past arithmetic operators:
$$\begin{array}{lllll}
(\expCompSingle{\odot_1 e}{e_2}{\beta})(x) &\rewriteRule{} \odot_1 (  \expCompSingle{e}{e_2}{\beta})(x) \\
(\expCompSingle{\sum_{\hat{\alpha}} e}{e_2}{\beta})(x) &\rewriteRule{} \sum_{\hat{\alpha}} (  \expCompSingle{e}{e_2}{\beta})(x) \\
\end{array}$$
The probe is distributed: 
$$\begin{array}{lllll}
(\expCompSingle{(e_a - e_b)}{e_2}{\beta})(x) &\rewriteRule{} (\expCompSingle{e_a}{e_2}{\beta})(x) -(\expCompSingle{e_b}{e_2}{\beta})(x) \\
(\expCompSingle{(e_a * e_b * e_s )}{e_2}{\beta})(x) &\rewriteRule{} (\expCompSingle{e_a}{e_2}{\beta})(x) * (\expCompSingle{e_b}{e_2}{\beta})(x)*(\expCompSingle{e_s}{e_2}{\beta})(x) \end{array}$$



%\paragraph{derivative}
The derivative of a field composition is applied by using the chain rule.\\
$$\nabla (F \circ G) \rowSurface (\nabla F \circ G)\bullet (\nabla G) $$
The derivative of a field composition of two fields is represented in the \name{} IR as 
$$\nabla_j (\expComp{F_\alpha}{G_{i\beta}}{i\beta}) \rewriteRule{}
\sum_{\hat{k}}( (\expComp{\nabla_k  F_\alpha}{G_{i\beta}}{i\beta}) * (\nabla_j G_{k\beta}) )$$
Generally we use the rewrite rule to apply the rewrite between two \name{} expressions:\\
$$\nabla_j (\expComp{e_1}{e_2}{i\beta}) \rewriteRule{}
\sum_{\hat{k}}( (\expComp{\nabla_k  e_1}{e_2}{i\beta}) * (\nabla_j \expIndex{e_2}{i}{k}) )$$


%\paragraph{flatten}
Flatten composition operator
$$ \expCompSingle{ (\expComp{a}{b}{m})}{c}{n} 
\rewriteRule{}
\expCompList{a}{b}{m}
$$

$$ \expComp{a}{\expCompSingle{b}{c}{n}}{m} 
\rewriteRule{}
\expCompList{a}{b}{m}
$$



\paragraph{Split}
After being normalized the probed composition operator is split into several probes.
$$
\text{\lstinline!out!} = \lambda F,G,x \EinExp{\expComp{F_\alpha}{G_\beta}{\beta}(x)}{\alpha}(F0, F1, x)
\rewriteSplit{}
\begin{array}{rl}
\lstinline!t!_0 = & \lambda G,x\EinExp{G_\beta(x)}{\hat{\beta}}(F1,x)\\
\text{\lstinline!out!}= & \lambda F,x \EinExp{F_\alpha(x)}{\alpha}(F0, \lstinline!t!_0)
 \end{array}$$
 